<div class="row mb-4">
  <div class="col-md-12">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Ana Sayfa</a></li>
        <li class="breadcrumb-item active"><%= @symbol %></li>
      </ol>
    </nav>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><%= @symbol %> - <%= @stock[:name] %></h4>
        <span class="badge <%= @trend == 'up' || @trend == 'strong_up' ? 'bg-success' : (@trend == 'down' || @trend == 'strong_down' ? 'bg-danger' : 'bg-secondary') %>">
          <%= @trend == 'up' || @trend == 'strong_up' ? 'Yükseliş' : (@trend == 'down' || @trend == 'strong_down' ? 'Düşüş' : 'Nötr') %>
        </span>
      </div>
      <div class="card-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <h5>Son Fiyat</h5>
            <h2 class="<%= @stock[:change].to_f > 0 ? 'text-success' : (@stock[:change].to_f < 0 ? 'text-danger' : 'text-muted') %>">
              <%= number_with_delimiter(@last_price) %> TL
              <small><%= @stock[:change].to_f > 0 ? '+' : '' %><%= @stock[:change] %> (<%= @stock[:change_percentage].to_f > 0 ? '+' : '' %><%= @stock[:change_percentage] %>%)</small>
            </h2>
          </div>
          <div class="col-md-6">
            <h5>Hacim</h5>
            <h2><%= number_with_delimiter(@stock[:volume_tl] || @stock[:volume] || 0) %></h2>
          </div>
        </div>
        
        <h5 class="mb-3">Fiyat Grafiği</h5>
        <% if @history && @history.any? %>
          <div class="chart-container" style="position: relative; height:300px;">
            <canvas id="priceChart"></canvas>
          </div>

          <script>
          document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            const prices = <%= (@history || []).map { |h| [h['date'] || h[:date], h['close'] || h[:close]] }.to_json %>;
            const ma10Data = <%= (@ma10 || []).to_json %>;
            const ma20Data = <%= (@ma20 || []).to_json %>;

            new Chart(ctx, {
              type: 'line',
              data: {
                labels: prices.map(p => p[0]),
                datasets: [
                  {
                    label: 'Fiyat',
                    data: prices.map(p => p[1]),
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                  },
                  {
                    label: '10 Günlük Ortalama',
                    data: ma10Data.map(p => p[1]),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderDash: [5, 5],
                    fill: false
                  },
                  {
                    label: '20 Günlük Ortalama',
                    data: ma20Data.map(p => p[1]),
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderDash: [5, 5],
                    fill: false
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                  y: {
                    beginAtZero: false
                  }
                }
              }
            });
          });
          </script>
        <% else %>
          <p>Geçmiş fiyat verisi yok.</p>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Teknik Analiz</h5>
      </div>
      <div class="card-body">
        <h6>Destek</h6>
        <ul class="list-group mb-3">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>Destek</span>
            <span class="badge bg-primary rounded-pill"><%= number_with_delimiter(@support) %> TL</span>
          </li>
        </ul>
        <h6>Direnç</h6>
        <ul class="list-group">
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>Direnç</span>
            <span class="badge bg-primary rounded-pill"><%= number_with_delimiter(@resistance) %> TL</span>
          </li>
        </ul>
        <hr>
        <h6>Trend</h6>
        <div>
          <% if @trend == 'up' || @trend == 'strong_up' %>
            <span class="badge bg-success">Yükselen Trend</span>
          <% elsif @trend == 'down' || @trend == 'strong_down' %>
            <span class="badge bg-danger">Düşen Trend</span>
          <% else %>
            <span class="badge bg-secondary">Nötr</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<form action="/favorites/add/<%= @symbol %>" method="post" style="display:inline;">
  <% if session[:favorites] && session[:favorites].include?(@symbol) %>
    <button type="submit" class="btn btn-secondary" disabled>Zaten Favorilerde</button>
  <% else %>
    <button type="submit" class="btn btn-primary">Favorilere Ekle</button>
  <% end %>
</form>
<a href="/" class="btn btn-link">Tüm Hisseler</a>
